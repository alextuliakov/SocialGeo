{% extends 'base.html' %}
{% load static %}
{% block title_page %}
  <title>
     Заметка {{ article.header }}
  </title>
{% endblock %}
{% block js_pre %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=73ca8a7c-00a0-4c08-882a-4c5f14e4958c&lang=ru_RU&load=package.full" type="text/javascript"></script>
  <script type="text/javascript">
    ymaps.ready(init);
    function init(){
        var map = new ymaps.Map("map",
         {
            center: [{{article.placemark.geometry.x_coord}}, {{article.placemark.geometry.y_coord}}],
            controls: [
                'geolocationControl',
                'typeSelector'
            ],
            zoom: 12,
        });
        var placemark
        var coords = [{{article.placemark.geometry.x_coord}}, {{article.placemark.geometry.y_coord}}];
        if (placemark) {
            placemark.geometry.setCoordinates(coords);
        }
        else {
            placemark = createPlacemark(coords);
            map.geoObjects.add(placemark);
            placemark.events.add('dragend', function () {
                getAddress(placemark.geometry.getCoordinates());
            });
        }
    }
    function createPlacemark(coords) {
        return new ymaps.Placemark(coords, {
                iconCaption: 'поиск...'
            },
            {
                iconLayout: 'default#image',
                iconImageHref: '/static/images/geo_point.png',
                iconImageSize: [48, 64],
                iconImageOffset: [-22, -50],
                hideIconOnBalloonOpen: false
            });
    }
    function append(username, av_url){
        textarea = document.getElementById('comment')
        data = {
            'context': textarea.value
        }
        $.ajax({
                type: 'GET',
                url: "/articles/{{article.id}}",
                data: data,
                success: function(response){ console.log("SUCCESS") },
                error: function(response) {console.log("ERROR")}
            })
        comments = document.getElementById('comments')
        comments.innerHTML = `<div class="card" style="margin-top:5px;"><div class="card-body">${textarea.value}<br><div class="contianer"><div class="row"><div class="col-3>"><a href="{% url 'geo_app:otherProfilePage' username=article.owner %}" class="text-muted text-decoration-none"><img src=${av_url} class="rounded-circle img-fluid" height="20" width="20">${username}</a></div><div class="col-4"></div><div class="col-5"><span class="text-muted text-decoration-none">{{comment.pub_date}}</span></div></div></div></div></div>` + comments.innerHTML
        textarea.value = ''
    }
    function like(){
        data = {
            'like': 'like'
        }
        $.ajax({
                type: 'GET',
                url: "/articles/{{article.id}}",
                data: data,
                success: function(response){ console.log("SUCCESS") },
                error: function(response) {console.log("ERROR")}
        })
        document.getElementById('likes').innerHTML = String(parseInt(document.getElementById('likes').innerHTML) + 1)
        document.getElementById('likeBtn').style = "width:2em;height:2em;background-color:rgba(237, 73, 85, 0.8); border: solid 1px; border-radius:4px;"
        document.getElementById('likeBtn').setAttribute('onclick', 'unlike()')
    }
    function unlike(){
        data = {
            'unlike': 'unlike'
        }
        $.ajax({
                type: 'GET',
                url: "/articles/{{article.id}}",
                data: data,
                success: function(response){ console.log("SUCCESS") },
                error: function(response) {console.log("ERROR")}
        })
        document.getElementById('likes').innerHTML = String(parseInt(document.getElementById('likes').innerHTML) - 1)
        document.getElementById('likeBtn').style = "width:2em;height:2em;background-color:transparent; border: solid 1px; border-radius:4px;"
        document.getElementById('likeBtn').setAttribute('onclick', 'like()')
    }
  </script>
{% endblock %}
{% block content %}
<div class="container" style="padding-top:40px;">
  <div class="row" height="50em">
    <div class="col-6">
    <div class="card">
        <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
          <div class="carousel-inner">
              {% for photo in article.fileupload_set.all %}
              {% if forloop.counter0 == 0 %}
                <div class="carousel-item active">
              {% else %}
                <div class="carousel-item">
              {% endif %}
                <img src="/media/{{photo.file}}" class="d-block w-100 card-img-top" alt="..." height="550em">
                </div>
              {% endfor %}
              <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
              </a>
              <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
              </a>
        </div>
      </div>
      <div class="card-body">
        <h5 class="card-title"> {{article.header}} </h5>
        <p class="card-text"> {{article.context}} </p>
      </div>
    </div>
    </div>
    <div class="col-6">
            <div style="height: 12em;">
            <div class="card-header">
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">Полный адрес: {{ article.placemark.address}}</li>
                <li class="list-group-item">Город: {{ article.placemark.city }}</li>
                <li class="list-group-item"> Кординаты объекта: x: {{ article.placemark.geometry.x_coord }},
                    y: {{ article.placemark.geometry.y_coord }}</li>
            </ul>
        </div>
        <div id="map" style="width: 100%; height: 30em;"></div>
    </div>
  </div>
  {% if request.user.is_authenticated %}
  <div class="row">
    <div class="col-6"><textarea id="comment" class="form-control" placeholder="Ваш комментарий..." ></textarea>
        <a class="btn btn-primary text-light" onclick="append('{{request.user}}', '/media/{{request.user.profile.avatar}}')">Комментировать</a>
    </div>
    {% if liked %}
    <div class="col-6">
        <button style="width:2em;height:2em; background-color:rgba(237, 73, 85, 0.8); border: solid 1px; border-radius:4px;" onclick="unlike()" id="likeBtn"><i class="fa fa-heart"></i></button>
        <span id="likes"> {{article.like_set.count}}</span>
    </div>
    {% else %}
    <div class="col-6">
        <button style="width:2em;height:2em;background-color:transparent; border: solid 1px; border-radius:4px;" onclick="like()" id="likeBtn"><i class="fa fa-heart"></i></button>
        <span id="likes"> {{article.like_set.count}}</span>
    </div>
    {% endif %}
  </div>
  <div class="row">
    <div class="col-6" id="comments">
        {% for comment in comments %}
            {% include 'articles/comment.html' %}
        {% endfor %}
    </div>
  </div>
  {% endif %}


</div>
{% endblock %}